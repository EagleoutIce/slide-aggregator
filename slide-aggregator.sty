%% slide-aggregator.sty
%%
%% --------------------------------------------------------------------------
%%
%% Autor: Florian Sihler, 22.02.2021
%%
%% Package to collect (probably lecture-)slides

% All internal commands are prefixed by 'sag'

\ProvidesPackage{slide-aggregator}[2021/02/22 v1.0 a slide aggregator package]

%% Packages
%% -----------------------------------------------------------------------------

\RequirePackage{hyperref}
\RequirePackage{afterpage,scrlayer-scrpage,etoolbox,bookmark,pdfpages,tikz}


%% Styles for markers
%% -----------------------------------------------------------------------------

\def\sag@default@font{\Large\upshape\sffamily}
\newlength\sag@subblock@len \sag@subblock@len=12cm

\tikzset{%
sag@blob/.style={%
    rectangle,rounded corners=2.75pt,%
    fill=#1!90!white,text=white,%
    font=\sag@default@font,%
    minimum height=2em,%
    inner xsep=2ex%
},%
sag@style@layout/.style={},%
sag@subnode/.style={below left,yshift=-.15cm,outer sep=0pt,inner sep=0pt,text width=\sag@subblock@len,align=right},%
sag@style@pgnode/.style={below left=0.25cm,sag@blob=clr!80!black,minimum width=3em}%
}

\colorlet{sag@default@color}{black}
\colorlet{sag@inactive@sub@color}{lightgray}
\def\sag@shadecolor#1{#1!50!white}

\let\@sag@tpstyle\textbf

%% Comment-Node
%% -----------------------------------------------------------------------------

\colorlet{sag@comment}{white!85!black}
\def\sag@commentname{\textit{Notiz:}}

\def\@sag@comment@node#1{%
\node[above left=0.25cm,sag@blob=sag@comment,text=black,%
    text width=8.5cm,fill opacity=0.65,text opacity=1,#1] (hkn)
    at (current page.south east) {% if (hook); (present(note)) => enote
    \@nameuse{sag@pagehook@\thepage}%
    \ifcsname sag@pagenote@\thepage\endcsname%
        \par\sag@commentname\space%
        \@nameuse{sag@pagenote@\thepage}%
    \fi\strut};
}

\def\sag@comment@node{\@sag@comment@node{\@nameuse{sag@ceop@\thepage}}}

%% headings
%% -----------------------------------------------------------------------------

% hierarchy: 'block|subblock'
% => auto wrapping?

\def\sag@start@block{%
% \node at (current page.north east) {\hypertarget{sag@pg:\thepage}{}\hypertarget{doc:\doc}{}};
% \node[sag@style@pgnode] (tp) at(current page.north east) {\thepage};% hypertarget to ensure correct position is hit
% \foreach[remember=\i as \li (initially 0)] \i in {1,...,\sag@br} {
%     \ifnum\i=\curi \def\opa{\@nameuse{color@\i}} \else \def\opa{lightgray} \fi
%     \ifnum\i=1
%     \node[below right=0.25cm,sag@blob=\opa] (p\i) at(current page.north west) {\hyperlink{doc:\@nameuse{file@\i}}{\i~\@nameuse{name@\i}}};
%     \else
%     \ifnum\i=5
%         \node[below right,yshift=-0.25cm,sag@blob=\opa] (p\i) at (p1.south west) {\hyperlink{doc:\@nameuse{file@\i}}{\i~\@nameuse{name@\i}}};
%     \else\ifnum\i=8
%         \node[below right,yshift=-0.25cm,sag@blob=\opa] (p\i) at (p5.south west) {\hyperlink{doc:\@nameuse{file@\i}}{\i~\@nameuse{name@\i}}};
%     \else
%     \node[right=0.25cm,sag@blob=\opa] (p\i) at (p\li.east) {\hyperlink{doc:\@nameuse{file@\i}}{\i~\@nameuse{name@\i}}};
%     \fi\fi\fi
%}
}

\def\sag@@pgmarker{\node at (current page.north east) {\sag@@ph\hypertarget{sag@pg:\thepage}{}};}
\def\sag@@pgblob{\node[below left=0.25cm,sag@blob=blkclr,outer sep=0pt] (tp) at(current page.north east) {\@sag@tpstyle{\thepage}};}

\def\sag@@commentblob{%
    \ifcsname sag@pagehook@\thepage\endcsname\sag@comment@node
    \else\ifcsname sag@pagenote@\thepage\endcsname\sag@comment@node\fi\fi
}

% there has to be at least one as assured by main loop
\def\sag@typesetsubblocks{%
    \hfill\foreach \sag@tmp@i in {1,...,\sag@cnt@sub@blk} {%
        \ifnum\sag@tmp@i=\sag@cur@sub@blk \def\sag@tmp{s}\else \def\sag@tmp{sd}\fi
        \@sag@ubox[\sag@tmp]{\sag@cur@blk @\sag@tmp@i}\space%
    }%
}

\def\sag@inblock{%
  \node[left=0.25cm] at(tp.west) {\expandafter\usebox\csname sag@s@\sag@cur@blk\endcsname};
  \node[sag@subnode] at (tp.south east) {\sag@typesetsubblocks};
  \sag@@commentblob
}

\newpairofpagestyles{lidag@layout}{%
\ihead{%
\hfill\begin{tikzpicture}[remember picture,overlay,sag@style@layout]
\sag@@pgmarker\sag@@pgblob
\ifx\@sag@blockinit@\sag@true \sag@start@block \else
\sag@inblock \fi
\gdef\sag@@ph{}% clear so it is one applic-only
\end{tikzpicture}}}

%% hooks
%% -----------------------------------------------------------------------------

\def\@sag@appto@list#1#2{%
    \ifcsname #1\endcsname%
    \def\@tempa{#2}\ifx\@tempa\@empty\else
        \csappto{#1}{,\space#2}\fi
    \else\@namedef{#1}{#2}\fi}

\newcommand\pagehook[3][]{%
    \@sag@appto@list{sag@ceop@#2}{#1}%
    \@sag@appto@list{sag@pagehook@#2}{#3}%
}

\newcommand\pagenote[3][]{%
    \@sag@appto@list{sag@ceop@#2}{#1}
    \@sag@appto@list{sag@pagenote@#2}{#3}
}

%% links
%% -----------------------------------------------------------------------------

\def\refslide#1{\textbf{\color{clr}\hyperlink{sag@pg:#1}{#1}}}
\def\reflink#1#2{\textbf{\color{clr}\href{#1}{#2}}}

%% block hooks
%% -----------------------------------------------------------------------------

\newcounter{sag@reg@block} \def\sag@br{\arabic{sag@reg@block}}
\newcounter{sag@reg@subblock} \def\sag@sr{\arabic{sag@reg@subblock}}

% every hook will precreate its corresponding savebox
% this should be fine

\def\@sag@sbox[#1]#2#3#4#5{%
    \expandafter\newsavebox\csname sag@#1@#2\endcsname
    \expandafter\savebox\csname sag@#1@#2\endcsname{%
        \tikz{\node [sag@blob=#3,#5] {#4};}%
    }%
}

\def\@sag@ubox[#1]#2{\expandafter\usebox\csname sag@#1@#2\endcsname}

\def\@sag@build@blkblob#1#2#3{%
    \@sag@sbox[s]{\sag@br}{#1}{\hyperlink{sag@blk:\sag@br}{\@sag@tpstyle{#2}}}{}%
    \@sag@sbox[sd]{\sag@br}{\sag@shadecolor{#1}}{\hyperlink{sag@blk:\sag@br}{#3}}{}%
}

\def\@sag@build@subblkblob#1#2#3{%
    \@sag@sbox[s]{\sag@br @\sag@sr}{#1}{\hyperlink{sag@sub@blk:\sag@br @\sag@sr}{#2}}{text=black}%
    \@sag@sbox[sd]{\sag@br @\sag@sr}{sag@inactive@sub@color}{\hyperlink{sag@sub@blk:\sag@br @\sag@sr}{#3}}{}%
}




\newcommand*\@sag@block[2][sag@default@color]{%
    \@ifnextchar[{\@sag@@block{#1}{#2}}{\@sag@@block{#1}{#2}[#2]}%
}
\def\@sag@@block#1#2[#3]{%
    \stepcounter{sag@reg@block}%
    \setcounter{sag@reg@subblock}{0}%
    \@namedef{sag@reg@subblock@\sag@br}{0}%
    \colorlet{color@\sag@br}{#1}%
    \@namedef{name@\sag@br}{#2}%
    \@namedef{short@\sag@br}{#3}%
    \@sag@build@blkblob{#1}{#2}{#3}%
}

\newcommand*\@sag@subblock[3][color@\sag@br]{%
    \@ifnextchar[{\@sag@@subblock{#1}{#2}{#3}}{\@sag@@subblock{#1}{#2}{#3}[#3]}%
}
\def\@sag@@subblock#1#2#3[#4]{
    \stepcounter{sag@reg@subblock}%
    \expandafter\edef\csname sag@reg@subblock@\sag@br\endcsname{\sag@sr}%
    \colorlet{color@@\sag@br @\sag@sr}{\sag@shadecolor{#1}}%
    \@namedef{file@@\sag@br @\sag@sr}{#2}%
    \@namedef{name@@\sag@br @\sag@sr}{#3}%
    \@namedef{short@@\sag@br @\sag@sr}{#4}%
    \@sag@build@subblkblob{color@@\sag@br @\sag@sr}{#3}{#4}%
}

\let\slideblock\@sag@block

\let\addslide\@sag@subblock

%% display command
%% -----------------------------------------------------------------------------

% newif did fail in nested cache?
\let\sag@true\@ne
\let\sag@false\tw@

\def\sag@init@block{
    \protected@edef\blktag{\@nameuse{name@\sag@cur@blk}}%
    \colorlet{blkclr}{color@\sag@cur@blk}%
    \let\@sag@blockinit@\sag@true%
    \appto\sag@@ph{\global\let\@sag@blockinit@\sag@false}%
    \edef\sag@cnt@sub@blk{\@nameuse{sag@reg@subblock@\sag@cur@blk}}%
    \typeout{\blktag\space[\sag@cnt@sub@blk]}%
}

\def\sag@init@subblock{
    \protected@edef\doc{\@nameuse{file@@\sag@cur@blk @\sag@cur@sub@blk}}%
    \colorlet{clr}{color@@\sag@cur@blk @\sag@cur@sub@blk}%
    \protected@edef\tag{\@nameuse{name@@\sag@cur@blk @\sag@cur@sub@blk}}%
    \typeout{   - \tag\space(\doc) [\sag@cur@sub@blk/\sag@cnt@sub@blk]}%
    \clearpage%
}

\def\sag@blk@prefix{\sag@cur@blk)\space}
\def\sag@sub@blk@prefix{\sag@cur@sub@blk)\space}

\def\@sag@display@slides@withsubs{%
    \sag@init@subblock
    % only insert bm if there is at least one slideset inside
    \ifnum\sag@cur@sub@blk=1\relax
        \pdfbookmark[0]{\sag@blk@prefix\blktag}{\doc-m}%
        \appto\sag@@ph{\hypertarget{sag@blk:\sag@cur@blk}{}}
    \fi
    \pdfbookmark[1]{\sag@sub@blk@prefix \tag}{\doc-s}%
    \appto\sag@@ph{\hypertarget{sag@sub@blk:\sag@cur@blk @\sag@cur@sub@blk}{}}
    % include with fixed layout
    \includepdf[pages=-,fitpaper,pagecommand={\thispagestyle{lidag@layout}}]{\doc.pdf}
}

\def\sag@display@slides@withsubs{
\foreach \sag@cur@blk in {1,...,\sag@br} {%
    \sag@init@block
    \ifnum\sag@cnt@sub@blk>0
    \foreach \sag@cur@sub@blk %
            in {1,...,\sag@cnt@sub@blk} {%
        \@sag@display@slides@withsubs
    }%
    \fi
}}

\def\displayslides{%
\ifnum\value{sag@reg@block}=0%
    ERROR: WIP FOR NO SUPS
\else
\sag@display@slides@withsubs
\fi}

\endinput