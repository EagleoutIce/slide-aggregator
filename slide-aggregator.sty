%% slide-aggregator.sty
%%
%% --------------------------------------------------------------------------
%%
%% Autor: Florian Sihler, 22.02.2021
%%
%% Package to collect (probably lecture-)slides

% All internal commands are prefixed by 'slidag'

\ProvidesPackage{slide-aggregator}[2020/08/22 v1.2 a color and palette control package based on xcolor]

%% Packages
%% -----------------------------------------------------------------------------

\RequirePackage{hyperref}
\RequirePackage{afterpage,scrlayer-scrpage,etoolbox,bookmark,pdfpages,tikz}


%% Styles for markers
%% -----------------------------------------------------------------------------

\tikzset{%
    slidag@blob/.style={%
        rectangle,rounded corners=2.75pt,%
        fill=#1!90!white,text=white!99!#1,%
        font=\large\sffamily\upshape\mdseries,%
        minimum height=.66cm,minimum width=1cm,%
        inner xsep=8pt%
    }%
}

%% Hooknode
%% -----------------------------------------------------------------------------

\colorlet{slidag@comment}{white!85!black}
\def\slidag@commentname{\textit{Notiz:}}

\def\@slidag@hknode#1{%
\node[above left=0.25cm,slidag@blob=slidag@comment,text=black,%
    text width=8.5cm,fill opacity=0.65,text opacity=1,#1] (tp)
    at (current page.south east) {% if (hook); (present(note)) => enote
    \@nameuse{slidag@pagehook@\thepage}%
    \ifcsname slidag@pagenote@\thepage\endcsname%
        \par\slidag@commentname\space%
        \@nameuse{slidag@pagenote@\thepage}%
    \fi\strut};
}

\def\slidag@hknode{\@slidag@hknode{\@nameuse{slidag@extraopts@\thepage}}}

%% headings
%% -----------------------------------------------------------------------------

% hierarchy: 'block|subblock'
% => auto wrapping?

\def\slidag@start@block{%
\node at (current page.north east) {\hypertarget{pg:\thepage}{}\hypertarget{doc:\doc}{}};
\node[below left=0.25cm,slidag@blob=\clr!85!black] (tp) at(current page.north east) {\thepage};% hypertarget to ensure correct position is hit
\foreach[remember=\i as \li (initially 0)] \i in {1,...,\arabic{slidag@reg@block}} {
    \ifnum\i=\curi \def\opa{\@nameuse{color@\i}} \else \def\opa{lightgray} \fi
    \ifnum\i=1
    \node[below right=0.25cm,slidag@blob=\opa] (p\i) at(current page.north west) {\hyperlink{doc:\@nameuse{file@\i}}{\i~\@nameuse{name@\i}}};
    \else
    \ifnum\i=5
        \node[below right,yshift=-0.25cm,slidag@blob=\opa] (p\i) at (p1.south west) {\hyperlink{doc:\@nameuse{file@\i}}{\i~\@nameuse{name@\i}}};
    \else\ifnum\i=8
        \node[below right,yshift=-0.25cm,slidag@blob=\opa] (p\i) at (p5.south west) {\hyperlink{doc:\@nameuse{file@\i}}{\i~\@nameuse{name@\i}}};
    \else
    \node[right=0.25cm,slidag@blob=\opa] (p\i) at (p\li.east) {\hyperlink{doc:\@nameuse{file@\i}}{\i~\@nameuse{name@\i}}};
    \fi\fi\fi
}}

\def\slidag@inblock{%
\node at (current page.north east) {\hypertarget{pg:\thepage}{}};
  \node[below left=0.25cm,slidag@blob=\clr!85!black] (tp) at(current page.north east) {\thepage};
  \node[left=0.25cm,slidag@blob=\clr] at(tp.west) {\currentbm};
  \ifcsname slidag@pagehook@\thepage\endcsname\slidag@hknode
  \else\ifcsname slidag@pagenote@\thepage\endcsname\slidag@hknode\fi
\fi
}

\newpairofpagestyles{lidag@layout}{%
\ihead{%
\begin{tikzpicture}[remember picture,overlay]
\ifx\currentbm\@empty\slidag@start@block\else
\slidag@inblock\fi
\end{tikzpicture}}}

%% hooks
%% -----------------------------------------------------------------------------

\newcommand\pagehook[3][]{%
\@namedef{slidag@extraopts@#2}{#1}%
\ifcsname slidag@pagehook@#2\endcsname
    \csappto{slidag@pagehook@#2}{,\space#3}%
\else
    \csappto{slidag@pagehook@#2}{#3}%
\fi
}

\newcommand\pagenote[3][]{%
\@namedef{slidag@extraopts@#2}{#1}%
\ifcsname slidag@pagenote@#2\endcsname
    \csappto{slidag@pagenote@#2}{,\space#3}%
\else
    \csappto{slidag@pagenote@#2}{#3}%
\fi
}

%% links
%% -----------------------------------------------------------------------------

\def\refslide#1{\textbf{\color{\clr}\hyperlink{pg:#1}{#1}}}
\def\reflink#1#2{\textbf{\color{\clr}\href{#1}{#2}}}

%% counter hooks
%% -----------------------------------------------------------------------------

\newcounter{slidag@reg@block}
\colorlet{slidag@default@color}{black}

\def\@slidag@block{\@ifnextchar[{\@@slidag@block}{\@@slidag@block[slidag@default@color]}}

\def\@@slidag@block[#1]#2: #3;{%
    \stepcounter{slidag@reg@block}%
    \@namedef{color@\arabic{slidag@reg@block}}{#1}%
    \@namedef{file@\arabic{slidag@reg@block}} {#2}%
    \@namedef{name@\arabic{slidag@reg@block}} {#3}%
}

\let\blockslide\@slidag@block

%% display command
%% -----------------------------------------------------------------------------

\def\displayslides{%
\foreach \i in {1,...,\arabic{slidag@reg@block}} {%
    \def\doc{\@nameuse{file@\i}}%
    \def\tag{\@nameuse{name@\i}}%
    \def\clr{\@nameuse{color@\i}}%
    \xdef\curi{\i}
    \clearpage
    \def\currentbm{}
    \afterpage{\gdef\currentbm{\hyperlink{doc:\doc}{\i~\tag}}}
    \pdfbookmark[0]{\i) \tag}{\doc-m}
    \includepdf[pages=-,fitpaper,pagecommand={\thispagestyle{lidag@layout}}]{\doc.pdf}
}}

\endinput